# Интеграция с MQTT

## Содержание
1. [Обзор](#обзор)
2. [Настройка MQTT](#настройка-mqtt)
3. [Структура топиков](#структура-топиков)
4. [Примеры использования](#примеры-использования)
5. [Интеграция с Home Assistant](#интеграция-с-home-assistant)
6. [Устранение неисправностей](#устранение-неисправностей)

## Обзор

MQTT (Message Queuing Telemetry Transport) - это лёгкий протокол обмена сообщениями, используемый для обмена данными между устройствами IoT. В GrowBox MQTT используется для:

- Отправки показаний датчиков
- Удалённого управления устройствами
- Интеграции с внешними системами (Home Assistant, Node-RED и др.)

## Настройка MQTT

### Требования

- MQTT-брокер (например, Mosquitto, EMQX, HiveMQ)
- Доступ к настройкам роутера (для проброса портов при необходимости)

### Настройка в веб-интерфейсе

1. Перейдите в раздел "Настройки" > "MQTT"
2. Заполните параметры подключения:
   - Адрес сервера (например, `mqtt://broker.hivemq.com`)
   - Порт (по умолчанию 1883 для незашифрованного соединения, 8883 для SSL/TLS)
   - Имя пользователя и пароль (если требуется аутентификация)
   - Префикс топиков (по умолчанию `growbox/`)
3. Нажмите "Сохранить"

### Настройка вручную (через конфигурационный файл)

1. Откройте файл `config/mqtt_config.json`
2. Измените параметры подключения:
   
   ```json
   {
     "enabled": true,
     "server": "mqtt://broker.hivemq.com",
     "port": 1883,
     "username": "",
     "password": "",
     "client_id": "growbox_01",
     "topic_prefix": "growbox/"
   }
   ```
3. Перезапустите устройство

## Структура топиков

### Основные топики

| Топик | Направление | Описание | Формат данных |
|-------|-------------|----------|---------------|
| `{prefix}/status` | → | Статус устройства | `{"online": true/false, "ip": "..."}` |
| `{prefix}/sensors` | → | Показания датчиков | См. ниже |
| `{prefix}/relay/{id}/set` | ← | Управление реле | `{"state": true/false, "duration": 0}` |
| `{prefix}/config` | ← | Конфигурация | См. раздел "Управление конфигурацией" |

### Формат сообщений датчиков

```json
{
  "temperature": 24.5,
  "humidity": 65.2,
  "ph": 6.2,
  "ec": 1200,
  "water_level": 85,
  "timestamp": "2023-04-15T14:30:00Z"
}
```

### Пример подписки на топики

```bash
# Подписка на все сообщения
topic 'growbox/#'

# Подписка на показания датчиков
topic 'growbox/sensors'

# Подписка на статус устройства
topic 'growbox/status'
```

## Примеры использования

### Отправка команд

Включить реле #1 на 60 секунд:

```bash
mosquitto_pub -h broker.hivemq.com -t 'growbox/relay/1/set' -m '{"state": true, "duration": 60}'
```

### Получение данных

Подписаться на показания датчиков:

```bash
mosquitto_sub -h broker.hivemq.com -t 'growbox/sensors'
```

## Интеграция с Home Assistant

### Автообнаружение (MQTT Discovery)

GrowBox поддерживает автоматическое обнаружение в Home Assistant через MQTT Discovery. Для включения:

1. Убедитесь, что MQTT Discovery включён в Home Assistant
2. Включите MQTT Discovery в настройках GrowBox
3. Перезапустите Home Assistant

### Ручная конфигурация

Добавьте в `configuration.yaml`:

```yaml
mqtt:
  sensor:
    - name: "GrowBox Temperature"
      state_topic: "growbox/sensors"
      unit_of_measurement: "°C"
      value_template: "{{ value_json.temperature }}"
    - name: "GrowBox Humidity"
      state_topic: "growbox/sensors"
      unit_of_measurement: "%"
      value_template: "{{ value_json.humidity }}"

  switch:
    - name: "GrowBox Relay 1"
      command_topic: "growbox/relay/1/set"
      state_topic: "growbox/relay/1/state"
      payload_on: '{"state": true}'
      payload_off: '{"state": false}'
      state_value_template: '{{ value_json.state }}'
      retain: true
```

## Управление конфигурацией

### Получение текущей конфигурации

```bash
mosquitto_sub -h broker.hivemq.com -t 'growbox/config/get'
mosquitto_pub -h broker.hivemq.com -t 'growbox/config/get' -m ''
```

### Обновление конфигурации

```bash
mosquitto_pub -h broker.hivemq.com -t 'growbox/config/set' -m '
{
  "wifi": {
    "ssid": "MyWiFi",
    "password": "securepassword"
  },
  "sensors": {
    "update_interval": 60
  }
}'
```

## Безопасность

### Рекомендации

1. Используйте шифрование (TLS/SSL)
2. Настройте аутентификацию на брокере
3. Используйте уникальные имена пользователей и сложные пароли
4. Ограничьте доступ к брокеру по IP-адресам
5. Регулярно обновляйте ПО брокера

### Настройка TLS

1. Сгенерируйте сертификаты для брокера
2. Загрузите CA-сертификат в GrowBox
3. Настройте подключение с использованием SSL/TLS в настройках MQTT

## Отладка

### Включение логов MQTT

1. Включите отладочный режим в настройках
2. Просматривайте логи через последовательный порт или веб-интерфейс
3. Используйте `mosquitto_sub` с флагом `-d` для отладки

### Пример отладки

```bash
# Просмотр всех сообщений с отладочной информацией
mosquitto_sub -h broker.hivemq.com -t 'growbox/#' -d
```

## Производительность

### Оптимизация

- Увеличьте интервал отправки данных при ограниченной пропускной способности
- Используйте QoS 0 для некритичных данных
- Включите сжатие сообщений при использовании мобильного интернета

### Ограничения

- Максимальный размер сообщения: 256 КБ
- Максимальная частота обновления: 1 Гц
- Поддерживается до 10 одновременных подписчиков

## Расширенные возможности

### Сценарии автоматизации

Используйте Node-RED для создания сложных сценариев на основе данных с датчиков.

### Интеграция с другими системами

- **Telegram** - уведомления и управление
- **IFTTT** - интеграция с сервисами
- **Google Sheets** - логирование данных
- **Grafana** - визуализация данных

## Часто задаваемые вопросы

**Q: Как изменить префикс топиков?**  
A: В настройках MQTT в веб-интерфейсе измените поле "Префикс топиков".

**Q: Как сбросить настройки MQTT?**  
A: Удалите файл конфигурации MQTT и перезагрузите устройство.

**Q: Как обновить прошивку через MQTT?**  
A: Отправьте команду обновления с указанием URL прошивки.

**Q: Как настроить резервное копирование через MQTT?**  
A: Подпишитесь на топик `growbox/backup` для получения резервных копий.
