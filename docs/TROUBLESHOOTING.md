# Устранение неисправностей GrowBox

## Содержание
1. [Общие проблемы](#общие-проблемы)
2. [Проблемы с WiFi](#проблемы-с-wifi)
3. [Проблемы с датчиками](#проблемы-с-датчиками)
4. [Проблемы с веб-интерфейсом](#проблемы-с-веб-интерфейсом)
5. [Проблемы с MQTT](#проблемы-с-mqtt)
6. [Проблемы с Telegram](#проблемы-с-telegram)
7. [Аппаратные проблемы](#аппаратные-проблемы)
8. [Восстановление после сбоя](#восстановление-после-сбоя)
9. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Общие проблемы

### Устройство не запускается

**Симптомы:**
- Нет индикации питания
- Не мигают светодиоды
- Нет доступа к веб-интерфейсу

**Возможные причины и решения:**
1. **Нет питания**
   - Проверьте подключение блока питания
   - Убедитесь, что напряжение на входе 5В ±5%
   - Проверьте целостность кабеля USB

2. **Зависание при загрузке**
   - Нажмите и удерживайте кнопку BOOT, затем нажмите RESET
   - Попробуйте прошить заново
   - Проверьте логи через последовательный порт

3. **Недостаточно памяти**
   - Увеличьте размер кучи в `sdkconfig`
   - Отключите неиспользуемые функции
   - Оптимизируйте использование памяти

## Проблемы с WiFi

### Не удаётся подключиться к WiFi

**Симптомы:**
- Устройство не подключается к сети
- Постоянные переподключения
- Низкая скорость передачи данных

**Решения:**
1. **Проверьте настройки WiFi**
   - Убедитесь, что SSID и пароль введены правильно
   - Проверьте, что сеть работает на частоте 2.4 ГГц
   - Убедитесь, что DHCP включён на роутере

2. **Улучшение стабильности**
   ```cpp
   // В коде инициализации WiFi
   WiFi.setAutoReconnect(true);
   WiFi.persistent(true);
   ```

3. **Диагностика**
   ```bash
   # Проверка силы сигнала
   iwconfig wlan0 | grep -i --color quality
   
   # Сканирование сетей
   iwlist wlan0 scan | grep ESSID
   ```

## Проблемы с датчиками

### Неточные показания

**Общие решения:**
1. **Калибровка**
   - Выполните калибровку датчиков
   - Используйте эталонные растворы для pH и EC
   - Убедитесь, что датчики чистые

2. **Помехи**
   - Используйте экранированные кабели
   - Установите конденсаторы 0.1 мкФ на питание датчиков
   - Избегайте прокладки сигнальных проводов рядом с силовыми

### Датчик не определяется

**Для I2C датчиков:**
1. Проверьте адрес устройства:
   ```cpp
   #include <Wire.h>
   
   void setup() {
     Wire.begin();
     Serial.begin(115200);
   }
   
   void loop() {
     byte error, address;
     for(address = 1; address < 127; address++ ) {
       Wire.beginTransmission(address);
       error = Wire.endTransmission();
       if (error == 0) {
         Serial.print("I2C устройство найдено по адресу 0x");
         Serial.println(address, HEX);
       }
     }
     delay(5000);
   }
   ```

**Для аналоговых датчиков:**
1. Проверьте напряжение на выходе датчика
2. Убедитесь, что АЦП правильно сконфигурирован
3. Проверьте опорное напряжение

## Проблемы с веб-интерфейсом

### Не загружается интерфейс

**Проверьте:**
1. Запущен ли веб-сервер
2. Доступность порта 80
3. Файловую систему LittleFS

**Логи:**
```
[E][WebServer.cpp:90] _handleRequest(): request handler not found
[E][WebServer.cpp:547] _handleFileRead(): can't open /index.html
```

**Решение:**
1. Прошейте файловую систему:
   ```bash
   pio run -t uploadfs
   ```
2. Проверьте права доступа к файлам
3. Увеличьте размер файловой системы в `platformio.ini`

## Проблемы с MQTT

### Нет соединения с брокером

**Проверьте:**
1. Доступность брокера:
   ```bash
   ping mqtt.broker.com
   nc -zv mqtt.broker.com 1883
   ```

2. Настройки подключения:
   - Адрес и порт брокера
   - Учётные данные
   - Префикс топиков

**Логи:**
```
[MQTT] Connection failed: -2
[MQTT] Disconnected: 0
```

**Решение:**
1. Проверьте настройки брандмауэра
2. Убедитесь, что брокер принимает соединения
3. Проверьте сертификаты при использовании TLS

## Проблемы с Telegram

### Бот не отвечает на команды

**Проверьте:**
1. Токен бота
2. Chat ID администратора
3. Настройки конфиденциальности бота

**Логи:**
```
[TELEGRAM] Send failed: 400 Bad Request
[TELEGRAM] Unauthorized
```

**Решение:**
1. Получите новый токен у @BotFather
2. Добавьте бота в чат и отправьте /start
3. Проверьте настройки конфиденциальности бота

## Аппаратные проблемы

### Перегрев ESP32

**Симптомы:**
- Нестабильная работа
- Самопроизвольные перезагрузки
- Ошибки в логах

**Решение:**
1. Установите радиатор
2. Улучшите вентиляцию корпуса
3. Снизьте тактовую частоту процессора

### Проблемы с питанием

**Симптомы:**
- Сбросы при включении нагрузки
- Искажённые показания АЦП
- Нестабильная работа WiFi

**Решение:**
1. Используйте стабилизированный источник питания
2. Установите конденсатор 1000 мкФ на входе питания
3. Разделите питание цифровой и аналоговой частей

## Восстановление после сбоя

### Сброс к заводским настройкам

1. Нажмите и удерживайте кнопку BOOT
2. Нажмите и отпустите кнопку RESET
3. Отпустите кнопку BOOT
4. Зайдите в веб-интерфейс по умолчанию (192.168.4.1)

### Восстановление прошивки

1. Подключитесь через последовательный порт
2. Удерживая кнопку BOOT, нажмите RESET
3. Загрузите прошивку:
   ```bash
   pio run -t upload --upload-port /dev/ttyUSB0
   ```

## Часто задаваемые вопросы

**Q: Как сбросить настройки к заводским?**  
A: Удерживайте кнопку BOOT при включении в течение 10 секунд.

**Q: Почему не сохраняются настройки?**  
A: Проверьте файловую систему и права доступа.

**Q: Как обновить прошивку?**  
A: Через веб-интерфейс (Настройки > Обновление) или по USB.

**Q: Как получить доступ к логам?**  
A: Через последовательный порт или веб-интерфейс (Система > Логи).

**Q: Почему не работает MQTT?**  
A: Проверьте подключение к брокеру, логин/пароль и настройки брандмауэра.

## Получение поддержки

1. Проверьте [документацию](README.md)
2. Поищите решение в [Issues](https://github.com/yourusername/growbox-esp32/issues)
3. Создайте новый Issue с подробным описанием проблемы
4. Укажите версию прошивки и шаги для воспроизведения
