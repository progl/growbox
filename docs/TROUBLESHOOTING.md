# Устранение неисправностей GrowBox

## Содержание
1. [Общие проблемы](#общие-проблемы)
2. [Проблемы с WiFi](#проблемы-с-wifi)
3. [Проблемы с датчиками](#проблемы-с-датчиками)
4. [Проблемы с веб-интерфейсом](#проблемы-с-веб-интерфейсом)
5. [Проблемы с MQTT](#проблемы-с-mqtt)
6. [Проблемы с Telegram](#проблемы-с-telegram)
7. [Проблемы с памятью](#проблемы-с-памятью)
8. [Восстановление после сбоя](#восстановление-после-сбоя)
9. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Общие проблемы

### Устройство не запускается

**Симптомы:**
- Нет индикации питания
- Не мигают светодиоды
- Нет доступа к веб-интерфейсу

**Возможные причины и решения:**
1. **Проблемы с питанием**
   - Проверьте подключение блока питания (5В ±5%)
   - Проверьте целостность кабеля USB
   - Убедитесь, что потребляемый ток не превышает 500мА для USB

2. **Проблемы с загрузкой**
   - Нажмите и удерживайте кнопку BOOT, затем нажмите RESET
   - Проверьте логи через последовательный порт (115200 бод)
   - Убедитесь, что используется правильная версия прошивки

3. **Проблемы с файловой системой**
   - Прошейте файловую систему: `pio run -t uploadfs`
   - Проверьте наличие всех необходимых файлов в LittleFS

## Проблемы с WiFi

### Не удаётся подключиться к WiFi

**Симптомы:**
- Устройство не подключается к сети
- Постоянные переподключения
- Низкая скорость передачи данных

**Решения:**
1. **Проверка настроек**
   - Убедитесь, что SSID и пароль введены правильно
   - Проверьте, что сеть работает на частоте 2.4 ГГц
   - Убедитесь, что DHCP включён на роутере

2. **Диагностика**
   ```bash
   # В мониторе порта проверьте логи подключения
   # Ищите сообщения о состоянии WiFi
   ```

3. **Оптимизация**
   - Уменьшите мощность передатчика WiFi, если устройство рядом с роутером
   - Используйте статический IP для стабильного подключения

## Проблемы с датчиками

### Датчики I2C не определяются

**Проверка:**
1. Убедитесь, что датчики правильно подключены (SDA/SCL)
2. Проверьте питание датчиков (3.3В или 5В в зависимости от модели)
3. Используйте скетч для сканирования I2C устройств

**Для DS18B20 (1-Wire):**
- Проверьте подтягивающий резистор 4.7кОм
- Убедитесь в правильности подключения проводов

### Неточные показания

**Для датчиков температуры/влажности (AHT10, AM2320):**
- Дайте датчику время для инициализации (1-2 сек)
- Избегайте конденсации на датчике

**Для датчиков EC/pH:**
- Выполните калибровку с эталонными растворами
- Промывайте электроды дистиллированной водой
- Храните электроды в специальном растворе

## Проблемы с веб-интерфейсом

### Не загружается веб-интерфейс

1. **Проверьте подключение:**
   - Убедитесь, что устройство подключено к сети
   - Проверьте IP-адрес в логах последовательного порта

2. **Очистка кеша:**
   - Нажмите Ctrl+F5 для принудительной перезагрузки страницы
   - Очистите кеш браузера

3. **Проверка файловой системы:**
   - Убедитесь, что все файлы веб-интерфейса загружены
   - Проверьте права доступа к файлам

## Проблемы с MQTT

### Нет подключения к брокеру

1. **Проверьте настройки:**
   - Адрес и порт брокера
   - Имя пользователя и пароль (если требуется)
   - Префикс топиков

2. **Диагностика:**
   - Проверьте логи MQTT в веб-интерфейсе
   - Убедитесь, что брокер доступен из сети

## Проблемы с Telegram

### Не приходят уведомления

1. **Проверьте настройки:**
   - Правильность токена бота
   - Корректность Chat ID
   - Настройки уведомлений в веб-интерфейсе

2. **Ограничения Telegram API:**
   - Не более 20 сообщений в минуту в чат
   - Максимальный размер сообщения: 4096 символов

## Проблемы с памятью

**Симптомы:**
- Случайные перезагрузки
- Потеря данных
- Ошибки выделения памяти

**Решения:**
1. Включите мониторинг памяти в настройках
2. Увеличьте размер кучи в platformio.ini:
   ```ini
   build_flags = -DCONFIG_ARDUHAL_LOG_COLORS=1 -DBOARD_HAS_PSRAM -mfix-esp32-psram-cache-issue
   ```
3. Оптимизируйте использование памяти:
   - Уменьшите размер буферов
   - Освобождайте неиспользуемые ресурсы
   - Используйте PSRAM, если доступна

## Восстановление после сбоя

1. **Сброс к заводским настройкам:**
   - Удерживайте кнопку BOOT при включении
   - В веб-интерфейсе: Настройки → Сброс настроек

2. **Обновление прошивки:**
   - Через веб-интерфейс (OTA)
   - Через последовательный порт с помощью esptool.py

## Часто задаваемые вопросы

**Q: Как получить доступ к устройству, если забыт IP-адрес?**
A: Используйте mDNS: `http://growbox.local` или сканер сети

**Q: Как сбросить настройки WiFi?**
A: Удерживайте кнопку BOOT при включении в течение 10 секунд

**Q: Как обновить прошивку?**
A: Через веб-интерфейс: Настройки → Обновление ПО

**Q: Где найти логи?**
A: В веб-интерфейсе: Система → Логи или через последовательный порт (115200 бод)
       error = Wire.endTransmission();
       if (error == 0) {
         Serial.print("I2C устройство найдено по адресу 0x");
         Serial.println(address, HEX);
       }
     }
     delay(5000);
   }
   ```

**Для аналоговых датчиков:**
1. Проверьте напряжение на выходе датчика
2. Убедитесь, что АЦП правильно сконфигурирован
3. Проверьте опорное напряжение

## Проблемы с веб-интерфейсом

### Не загружается интерфейс

**Проверьте:**
1. Запущен ли веб-сервер
2. Доступность порта 80
3. Файловую систему LittleFS

**Логи:**
```
[E][WebServer.cpp:90] _handleRequest(): request handler not found
[E][WebServer.cpp:547] _handleFileRead(): can't open /index.html
```

**Решение:**
1. Прошейте файловую систему:
   ```bash
   pio run -t uploadfs
   ```
2. Проверьте права доступа к файлам
3. Увеличьте размер файловой системы в `platformio.ini`

## Проблемы с MQTT

### Нет соединения с брокером

**Проверьте:**
1. Доступность брокера:
   ```bash
   ping mqtt.broker.com
   nc -zv mqtt.broker.com 1883
   ```

2. Настройки подключения:
   - Адрес и порт брокера
   - Учётные данные
   - Префикс топиков

**Логи:**
```
[MQTT] Connection failed: -2
[MQTT] Disconnected: 0
```

**Решение:**
1. Проверьте настройки брандмауэра
2. Убедитесь, что брокер принимает соединения
3. Проверьте сертификаты при использовании TLS

## Проблемы с Telegram

### Бот не отвечает на команды

**Проверьте:**
1. Токен бота
2. Chat ID администратора
3. Настройки конфиденциальности бота

**Логи:**
```
[TELEGRAM] Send failed: 400 Bad Request
[TELEGRAM] Unauthorized
```

**Решение:**
1. Получите новый токен у @BotFather
2. Добавьте бота в чат и отправьте /start
3. Проверьте настройки конфиденциальности бота

## Аппаратные проблемы

### Перегрев ESP32

**Симптомы:**
- Нестабильная работа
- Самопроизвольные перезагрузки
- Ошибки в логах

**Решение:**
1. Установите радиатор
2. Улучшите вентиляцию корпуса
3. Снизьте тактовую частоту процессора

### Проблемы с питанием

**Симптомы:**
- Сбросы при включении нагрузки
- Искажённые показания АЦП
- Нестабильная работа WiFi

**Решение:**
1. Используйте стабилизированный источник питания
2. Установите конденсатор 1000 мкФ на входе питания
3. Разделите питание цифровой и аналоговой частей

## Восстановление после сбоя

### Сброс к заводским настройкам

1. Нажмите и удерживайте кнопку BOOT
2. Нажмите и отпустите кнопку RESET
3. Отпустите кнопку BOOT
4. Зайдите в веб-интерфейс по умолчанию (192.168.4.1)

### Восстановление прошивки

1. Подключитесь через последовательный порт
2. Удерживая кнопку BOOT, нажмите RESET
3. Загрузите прошивку:
   ```bash
   pio run -t upload --upload-port /dev/ttyUSB0
   ```

## Часто задаваемые вопросы

**Q: Как сбросить настройки к заводским?**  
A: Удерживайте кнопку BOOT при включении в течение 10 секунд.

**Q: Почему не сохраняются настройки?**  
A: Проверьте файловую систему и права доступа.

**Q: Как обновить прошивку?**  
A: Через веб-интерфейс (Настройки > Обновление) или по USB.

**Q: Как получить доступ к логам?**  
A: Через последовательный порт или веб-интерфейс (Система > Логи).

**Q: Почему не работает MQTT?**  
A: Проверьте подключение к брокеру, логин/пароль и настройки брандмауэра.

## Получение поддержки

1. Проверьте [документацию](README.md)
2. Поищите решение в [Issues](https://github.com/yourusername/growbox-esp32/issues)
3. Создайте новый Issue с подробным описанием проблемы
4. Укажите версию прошивки и шаги для воспроизведения
